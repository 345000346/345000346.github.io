const closeNav=()=>{const e=document.getElementById("nav-content"),t=document.getElementById("nav-toggle");e&&e.classList.add("hidden"),t&&t.setAttribute("aria-expanded","false")},openNav=()=>{const e=document.getElementById("nav-content"),t=document.getElementById("nav-toggle");e&&e.classList.remove("hidden"),t&&t.setAttribute("aria-expanded","true")},applyThemeIcons=e=>{const t=document.getElementById("light-icon"),n=document.getElementById("dark-icon");if(!t||!n)return;e?(t.classList.add("hidden"),n.classList.remove("hidden")):(t.classList.remove("hidden"),n.classList.add("hidden"))},initTheme=()=>{const t=document.documentElement,e=localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches;e?(t.classList.add("dark"),localStorage.theme="dark"):(t.classList.remove("dark"),localStorage.theme="light"),applyThemeIcons(e),updateBadgeThemes(e)},animateThemeButton=()=>{const e=document.getElementById("switchTheme");if(!e)return;e.classList.remove("theme-animating"),void e.offsetWidth,e.classList.add("theme-animating")},handleThemeToggle=e=>{const t=document.documentElement,a=t.classList.contains("dark"),o=!a;t.classList.contains("theme-ready")||t.classList.add("theme-ready");const i=()=>{o?(t.classList.add("dark"),localStorage.theme="dark"):(t.classList.remove("dark"),localStorage.theme="light"),applyThemeIcons(o),updateBadgeThemes(o)};animateThemeButton();const r=window.matchMedia("(prefers-reduced-motion: reduce)").matches;if(!document.startViewTransition||r){i();return}const n=e?.clientX??window.innerWidth-40,s=e?.clientY??40,c=Math.hypot(Math.max(n,window.innerWidth-n),Math.max(s,window.innerHeight-s));t.style.setProperty("--theme-switch-x",`${n}px`),t.style.setProperty("--theme-switch-y",`${s}px`);const l=document.startViewTransition(()=>{i()});l.ready.then(()=>{document.documentElement.animate({clipPath:[`circle(0px at ${n}px ${s}px)`,`circle(${c}px at ${n}px ${s}px)`]},{duration:640,easing:"cubic-bezier(0.16, 1, 0.3, 1)",pseudoElement:"::view-transition-new(root)"})})},updateBadgeThemes=(e=document.documentElement.classList.contains("dark"))=>{document.querySelectorAll(".themed-badge").forEach(t=>{const n=t.getAttribute("data-light-src"),s=t.getAttribute("data-dark-src");t.src=e?s:n})},handleScroll=()=>{const t=document.querySelector("#progress"),e=document.getElementById("nav-content"),n=window.scrollY,s=document.documentElement.scrollHeight-document.documentElement.clientHeight;t&&s>0&&t.style.setProperty("--scroll",`${n/s*100}%`),e&&(n>10?e.classList.remove("bg-gray-100"):e.classList.add("bg-gray-100"))},handleCodeFolding=()=>{document.querySelectorAll(".highlight").forEach((e,t)=>{const n=e.querySelector("pre");if(n&&n.scrollHeight>200){n.style.maxHeight="200px";const o=`code-block-${t}`;n.id=o;const s=document.createElement("div");s.className="code-toggle",s.setAttribute("role","button"),s.setAttribute("tabindex","0"),s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",o),s.setAttribute("aria-label","展开代码块"),s.innerHTML='<span class="code-toggle-text">展开</span><i class="iconfont icon-arrow-down"></i>';const i=()=>{const e=n.style.maxHeight!=="200px";n.style.maxHeight=e?"200px":"none",s.setAttribute("aria-expanded",!e),s.setAttribute("aria-label",e?"展开代码块":"收起代码块"),s.querySelector(".code-toggle-text").textContent=e?"展开":"收起"};s.onclick=i,s.onkeydown=e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),i())},e.insertBefore(s,n)}})},renderPoemFallback=e=>{const t=e.querySelector(".poem-sentence"),n=e.querySelector(".poem-info");if(!t||!n)return;t.textContent="今日诗词加载失败",n.textContent=""},renderPoem=(e,t)=>{const n=e.querySelector(".poem-sentence"),s=e.querySelector(".poem-info");if(!n||!s)return;if(!t||!t.data||!t.data.origin){renderPoemFallback(e);return}n.textContent=t.data.content,s.textContent="【"+t.data.origin.dynasty+"】"+t.data.origin.author+"《"+t.data.origin.title+"》"},loadPoemForCard=e=>{if(!window.jinrishici||!window.jinrishici.load)return;window.jinrishici.load(t=>{try{renderPoem(e,t)}catch{renderPoemFallback(e)}})},loadPoemSdkOnce=()=>{if(window.jinrishici?.load){document.dispatchEvent(new Event("jinrishici:ready"));return}if(window.__jinrishici_script_loading)return;window.__jinrishici_script_loading=!0;const e=document.createElement("script");e.src="https://sdk.jinrishici.com/v2/browser/jinrishici.js",e.charset="utf-8",e.defer=!0,e.onload=()=>{document.dispatchEvent(new Event("jinrishici:ready"))},e.onerror=()=>{document.dispatchEvent(new Event("jinrishici:error"))},document.head.appendChild(e)},initPoemCards=()=>{const t=document.querySelectorAll(".poem-card");if(!t.length)return;const e=[];if(t.forEach(t=>{if(t.dataset.jinrishiciInit==="1")return;t.dataset.jinrishiciInit="1",e.push(t)}),!e.length)return;const n=()=>{e.forEach(e=>{loadPoemForCard(e)})},s=()=>{e.forEach(e=>{renderPoemFallback(e)})};document.addEventListener("jinrishici:ready",n,{once:!0}),document.addEventListener("jinrishici:error",s,{once:!0}),loadPoemSdkOnce()};document.addEventListener("DOMContentLoaded",()=>{document.body.addEventListener("click",e=>{if(e.target.closest("#nav-toggle")){const e=document.getElementById("nav-content");e?.classList.contains("hidden")?openNav():closeNav()}else e.target.closest("#nav-content a")&&closeNav();e.target.closest("#switchTheme")&&handleThemeToggle(e)});const e=window.matchMedia("(prefers-color-scheme: dark)");e.addEventListener("change",e=>{if(!localStorage.getItem("theme")){const t=e.matches;t?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),applyThemeIcons(t),updateBadgeThemes(t)}}),document.addEventListener("scroll",handleScroll),initTheme(),requestAnimationFrame(()=>{document.documentElement.classList.add("theme-ready")}),handleCodeFolding(),initPoemCards(),handleScroll()})