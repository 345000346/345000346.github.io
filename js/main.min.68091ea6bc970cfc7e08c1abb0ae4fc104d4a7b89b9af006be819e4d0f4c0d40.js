const closeNav=()=>{const e=document.getElementById("nav-content"),t=document.getElementById("nav-toggle");e&&e.classList.add("hidden"),t&&t.setAttribute("aria-expanded","false")},openNav=()=>{const e=document.getElementById("nav-content"),t=document.getElementById("nav-toggle");e&&e.classList.remove("hidden"),t&&t.setAttribute("aria-expanded","true")},getStoredThemePreference=()=>{const e=localStorage.getItem("theme");return e==="light"||e==="dark"?e:(e!==null&&localStorage.removeItem("theme"),null)},applyRootThemeState=e=>{const t=document.documentElement;t.classList.toggle("dark",e),t.dataset.theme=e?"dark":"light",t.style.colorScheme=e?"dark":"light",t.style.setProperty("--theme-bg",e?"#374151":"#f3f4f6"),t.style.setProperty("--theme-fg",e?"#f3f4f6":"#111827"),t.style.setProperty("--theme-surface",e?"#1f2937":"#ffffff")},applyThemeIcons=e=>{const t=document.getElementById("light-icon"),n=document.getElementById("dark-icon"),s=document.getElementById("switchTheme");if(!t||!n)return;e?(t.classList.add("hidden"),n.classList.remove("hidden")):(t.classList.remove("hidden"),n.classList.add("hidden")),s&&(s.setAttribute("aria-pressed",String(e)),s.setAttribute("aria-label",e?"切换为浅色模式":"切换为深色模式"))},initTheme=()=>{const t=getStoredThemePreference(),e=t==="dark"||t===null&&window.matchMedia("(prefers-color-scheme: dark)").matches;applyRootThemeState(e),applyThemeIcons(e),updateBadgeThemes(e)},animateThemeButton=()=>{const e=document.getElementById("switchTheme");if(!e)return;e.classList.remove("theme-animating"),void e.offsetWidth,e.classList.add("theme-animating")};let themeToastElement,themeToastTimer;const ensureThemeToast=()=>{if(themeToastElement)return themeToastElement;const e=document.createElement("div");return e.id="theme-toast",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),document.body.appendChild(e),themeToastElement=e,e},showThemeToast=e=>{const t=ensureThemeToast();t.textContent=e?"已切换为深色模式":"已切换为浅色模式",t.classList.remove("is-visible"),void t.offsetWidth,t.classList.add("is-visible"),themeToastTimer&&window.clearTimeout(themeToastTimer),themeToastTimer=window.setTimeout(()=>{t.classList.remove("is-visible")},1500)},handleThemeToggle=e=>{const t=document.documentElement,a=t.classList.contains("dark"),n=!a;t.classList.contains("theme-ready")||t.classList.add("theme-ready");const i=()=>{applyRootThemeState(n),localStorage.theme=n?"dark":"light",applyThemeIcons(n),updateBadgeThemes(n),showThemeToast(n)};animateThemeButton();const r=window.matchMedia("(prefers-reduced-motion: reduce)").matches;if(!document.startViewTransition||r){i();return}const s=e?.clientX??window.innerWidth-40,o=e?.clientY??40,c=Math.hypot(Math.max(s,window.innerWidth-s),Math.max(o,window.innerHeight-o));t.style.setProperty("--theme-switch-x",`${s}px`),t.style.setProperty("--theme-switch-y",`${o}px`);const l=document.startViewTransition(()=>{i()});l.ready.then(()=>{document.documentElement.animate({clipPath:[`circle(0px at ${s}px ${o}px)`,`circle(${c}px at ${s}px ${o}px)`]},{duration:640,easing:"cubic-bezier(0.16, 1, 0.3, 1)",pseudoElement:"::view-transition-new(root)"})})},updateBadgeThemes=(e=document.documentElement.classList.contains("dark"))=>{document.querySelectorAll(".themed-badge").forEach(t=>{const n=t.getAttribute("data-light-src"),s=t.getAttribute("data-dark-src");t.src=e?s:n})},handleScroll=()=>{const t=document.querySelector("#progress"),e=document.getElementById("nav-content"),n=window.scrollY,s=document.documentElement.scrollHeight-document.documentElement.clientHeight;t&&s>0&&t.style.setProperty("--scroll",`${n/s*100}%`),e&&(n>10?e.classList.remove("bg-gray-100"):e.classList.add("bg-gray-100"))},handleCodeFolding=()=>{document.querySelectorAll(".highlight").forEach((e,t)=>{const n=e.querySelector("pre");if(n&&n.scrollHeight>200){n.style.maxHeight="200px";const o=`code-block-${t}`;n.id=o;const s=document.createElement("div");s.className="code-toggle",s.setAttribute("role","button"),s.setAttribute("tabindex","0"),s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",o),s.setAttribute("aria-label","展开代码块"),s.innerHTML='<span class="code-toggle-text">展开</span><i class="iconfont icon-arrow-down"></i>';const i=()=>{const e=n.style.maxHeight!=="200px";n.style.maxHeight=e?"200px":"none",s.setAttribute("aria-expanded",!e),s.setAttribute("aria-label",e?"展开代码块":"收起代码块"),s.querySelector(".code-toggle-text").textContent=e?"展开":"收起"};s.onclick=i,s.onkeydown=e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),i())},e.insertBefore(s,n)}})},renderPoemFallback=e=>{const t=e.querySelector(".poem-sentence"),n=e.querySelector(".poem-info");if(!t||!n)return;t.textContent="今日诗词加载失败",n.textContent=""},renderPoem=(e,t)=>{const n=e.querySelector(".poem-sentence"),s=e.querySelector(".poem-info");if(!n||!s)return;if(!t||!t.data||!t.data.origin){renderPoemFallback(e);return}n.textContent=t.data.content,s.textContent="【"+t.data.origin.dynasty+"】"+t.data.origin.author+"《"+t.data.origin.title+"》"},loadPoemForCard=e=>{if(!window.jinrishici||!window.jinrishici.load)return;window.jinrishici.load(t=>{try{renderPoem(e,t)}catch{renderPoemFallback(e)}})},loadPoemSdkOnce=()=>{if(window.jinrishici?.load){document.dispatchEvent(new Event("jinrishici:ready"));return}if(window.__jinrishici_script_loading)return;window.__jinrishici_script_loading=!0;const e=document.createElement("script");e.src="https://sdk.jinrishici.com/v2/browser/jinrishici.js",e.charset="utf-8",e.defer=!0,e.onload=()=>{document.dispatchEvent(new Event("jinrishici:ready"))},e.onerror=()=>{document.dispatchEvent(new Event("jinrishici:error"))},document.head.appendChild(e)},initPoemCards=()=>{const t=document.querySelectorAll(".poem-card");if(!t.length)return;const e=[];if(t.forEach(t=>{if(t.dataset.jinrishiciInit==="1")return;t.dataset.jinrishiciInit="1",e.push(t)}),!e.length)return;const n=()=>{e.forEach(e=>{loadPoemForCard(e)})},s=()=>{e.forEach(e=>{renderPoemFallback(e)})};document.addEventListener("jinrishici:ready",n,{once:!0}),document.addEventListener("jinrishici:error",s,{once:!0}),loadPoemSdkOnce()};document.addEventListener("DOMContentLoaded",()=>{document.body.addEventListener("click",e=>{if(e.target.closest("#nav-toggle")){const e=document.getElementById("nav-content");e?.classList.contains("hidden")?openNav():closeNav()}else e.target.closest("#nav-content a")&&closeNav();e.target.closest("#switchTheme")&&handleThemeToggle(e)});const e=window.matchMedia("(prefers-color-scheme: dark)");e.addEventListener("change",e=>{if(getStoredThemePreference()===null){const t=e.matches;applyRootThemeState(t),applyThemeIcons(t),updateBadgeThemes(t)}}),document.addEventListener("scroll",handleScroll),initTheme(),handleCodeFolding(),initPoemCards(),handleScroll()})